<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Eterna Mirror Â· æ—©å®‰ï¼‹æ–°èæ’­å ±ï¼ˆèªéŸ³å«å¤©æ°£ï¼‰</title>
<style>
  html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; color:#fff;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans","PingFang TC","Microsoft JhengHei",sans-serif; }
  #videoBg { position:fixed; inset:0; width:100%; height:100%; object-fit:cover; transform: scaleX(-1); z-index:0; background:#000; }
  header { position: fixed; top:0; left:0; right:0; z-index:2; text-align:center; padding:1.2vh 2vw 2vh;
    background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,0)); pointer-events:none; }
  h1 { font-size: clamp(26px, 5.5vw, 56px); margin:.2em 0; text-shadow: 0 2px 18px rgba(0,0,0,.45); }
  .sub { opacity:.9; font-size: clamp(12px, 2.5vw, 16px); }
  .time { font-size: clamp(18px, 4vw, 36px); font-variant-numeric: tabular-nums; margin-top:.2em; }
  .side { position: fixed; top: 14vh; bottom: 6vh; width: 22vw; z-index:2;
    display:flex; flex-direction:column; gap: 1.2vh; padding: 0 1vw; pointer-events: none; }
  .left { left: 0; align-items: flex-start; }
  .right { right: 0; align-items: flex-end; }
  .card { width: 100%; max-width: 360px; pointer-events:auto; background: rgba(0,0,0,.45);
    border:1px solid rgba(255,255,255,.18); border-radius: 14px; padding: .8em 1em; backdrop-filter: blur(8px); }
  .title { font-size: clamp(16px,3.6vw,22px); opacity:.95; margin:0 0 .1em; }
  .val { font-size: clamp(16px,3.8vw,24px); font-variant-numeric: tabular-nums; opacity:.95; }
  .note { font-size: clamp(12px,2.6vw,16px); opacity:.8; }
  .tasks li { margin: .2em 0; font-size: clamp(14px,3.6vw,18px); opacity:.95; }
  .gm-card { flex:1; display:flex; }
  #gmWrap { display:flex; align-items:center; justify-content:center; width:100%; border-radius:14px;
    background: rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.18); padding:.4em; }
  #gmWrap img { max-width:100%; max-height:100%; border-radius:12px; object-fit:contain; }
  .floating { position: fixed; right: 2vw; bottom: 8vh; z-index:2; display:flex; gap:.6em; align-items:center; }
  .btn { background: rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.25); border-radius:12px; padding:.55em .85em; backdrop-filter: blur(8px); font-size: clamp(12px,2.8vw,14px); }
  .select { appearance:none; background: rgba(0,0,0,.45); color:#fff; border:1px solid rgba(255,255,255,.25); border-radius:12px; padding:.55em .85em; backdrop-filter: blur(8px); font-size: clamp(12px,2.8vw,14px); }
  @media (max-width: 1024px){ .side { width: 28vw; gap: 1vh; } }
  @media (max-width: 768px){ header { padding: .8vh 2vw 1.2vh; } .side { width: 34vw; top: 12vh; bottom: 8vh; } .title { font-size: clamp(14px,4vw,18px); } .val { font-size: clamp(14px,4.4vw,20px); } }
</style>
</head>
<body>
  <video id="videoBg" autoplay playsinline muted></video>
  <header>
    <h1>æ—©å®‰ï¼Œä»Šå¤©ä¹Ÿä¸€èµ·åŠ æ²¹</h1>
    <div class="sub" id="date"></div>
    <div class="time" id="time"></div>
  </header>

  <!-- å·¦å´ï¼šæœè—¥æé†’ / è¦ªå‹å•å€™ / æ—©å®‰åœ– -->
  <section class="side left">
    <div class="card">
      <div class="title">æœè—¥æé†’</div>
      <div class="val">æ—©ä¸Š A è—¥ 1 é¡†</div>
      <div class="note">09:00 è¨˜å¾—æœç”¨</div>
    </div>
    <div class="card">
      <div class="title">è¦ªå‹å•å€™</div>
      <div class="val">å­«å¥³ï¼šæ—©å®‰é˜¿å…¬ â¤ï¸</div>
    </div>
    <div class="gm-card">
      <div id="gmWrap">
        <img id="gmImg" src="" alt="æ—©å®‰åœ–">
      </div>
    </div>
  </section>

  <!-- å³å´ï¼šå¿ƒè·³ï¼ˆç½®é ‚ï¼‰ / è¡€å£“ï¼ˆå«é«”æº«å‰¯æ¨™ï¼‰ / ä»Šæ—¥ä»»å‹™ -->
  <section class="side right">
    <div class="card">
      <div class="title">å¿ƒè·³</div>
      <div class="val">72 bpm</div>
    </div>
    <div class="card">
      <div class="title">è¡€å£“</div>
      <div class="val">125 / 78</div>
      <div class="note">é«”æº« 36.6 Â°C</div>
    </div>
    <div class="card">
      <div class="title">ä»Šæ—¥ä»»å‹™</div>
      <ul id="taskList" class="tasks">
        <li>â€¢ å»é†«é™¢å¾©å¥ï¼ˆ10:00ï¼‰</li>
        <li>â€¢ åœ–æ›¸é¤¨æ›¸åˆ°æœŸï¼ˆä»Šå¤©æˆ–ç·šä¸ŠçºŒå€Ÿï¼‰</li>
        <li>â€¢ æ¸¬ä¸€æ¬¡è¡€å£“</li>
      </ul>
    </div>
  </section>

  <div class="floating">
    <button class="btn" id="speakBtn" onclick="toggleSpeak()">ğŸ”Š èªéŸ³æ’­å ±</button>
    <select id="newsCategory" class="select" title="é¸æ“‡æ–°èåˆ†é¡">
      <option value="market">è‚¡å¸‚</option>
      <option value="international">åœ‹éš›</option>
      <option value="tech">ç§‘æŠ€</option>
      <option value="sports">é«”è‚²</option>
      <option value="taiwan">å°ç£</option>
    </select>
    <button class="btn" id="newsBtn" onclick="toggleNews()">ğŸ“° æ’­å ±æ–°è</button>
    <button class="btn" id="musicBtn" onclick="toggleMusic()">ğŸµ æ’­éŸ³æ¨‚</button>
  </div>

  <!-- éŸ³æ¨‚æ’­æ”¾å™¨ -->
  <audio id="bgMusic" src="music/sample.mp3" loop></audio>

  <script>
    // ====== æ™‚é–“ ======
    function pad(n){return n<10? '0'+n : n}
    function tick(){
      const now = new Date();
      document.getElementById('date').textContent =
        now.toLocaleDateString('zh-TW',{year:'numeric',month:'long',day:'numeric',weekday:'long'});
      document.getElementById('time').textContent = pad(now.getHours()) + ':' + pad(now.getMinutes());
    }
    setInterval(tick, 1000); tick();

    // ====== ä»»å‹™ï¼šå›ºå®šå…©é … + æ¯æ—¥å†æŠ½ 1 é … ======
    const fixedTasks = ['å»é†«é™¢å¾©å¥ï¼ˆ10:00ï¼‰','åœ–æ›¸é¤¨æ›¸åˆ°æœŸï¼ˆä»Šå¤©æˆ–ç·šä¸ŠçºŒå€Ÿï¼‰'];
    const pool = ['å–æ°´ 6 æ¯','ä¼¸å±• 10 åˆ†é˜','çœ‹çœ‹æ˜¨å¤©çš„ç…§ç‰‡ / ç•™è¨€','å»ç¤¾å€ä¸­åº­èµ°èµ° 5 åˆ†é˜','æ°´æœä¸€ä»½ï¼ˆé¦™è•‰/è˜‹æœï¼‰','æ‰“é›»è©±çµ¦æœ‹å‹å•å€™ 5 åˆ†é˜'];
    function pickTasks(){
      const i = Math.floor(Math.random()*pool.length);
      const selected = pool[i];
      document.getElementById('taskList').innerHTML = ['â€¢ '+fixedTasks[0],'â€¢ '+fixedTasks[1],'â€¢ '+selected].map(t=>'<li>'+t+'</li>').join('');
    }
    pickTasks();

    // ====== æ—©å®‰åœ–ï¼šéš¨æ©Ÿä¸€å¼µ ======
    const gmImages = [
      "images/goodmorning/1.jpg",
      "images/goodmorning/2.jpg",
      "images/goodmorning/3.jpg",
      "images/goodmorning/4.jpg",
      "images/goodmorning/5.jpg",
      "images/goodmorning/6.jpg",
      "images/goodmorning/7.jpg",
      "images/goodmorning/8.jpg",
      "images/goodmorning/9.jpg"
    ];
    (function showRandomGM(){
      const idx = Math.floor(Math.random()*gmImages.length);
      const el = document.getElementById('gmImg');
      if (el) el.src = gmImages[idx];
    })();

    // ====== ç›¸æ©Ÿï¼ˆå¯ç§»é™¤ï¼›åƒ…ä½œç‚ºèƒŒæ™¯ï¼‰ ======
    let currentFacing = 'user', currentStream = null;
    async function startCamera(){
      stopCamera();
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: currentFacing, width: { ideal: 1280 }, height: { ideal: 720 } },
          audio: false
        });
        currentStream = stream;
        const video = document.getElementById('videoBg');
        video.srcObject = stream;
      } catch (e) { console.warn('ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿï¼š' + e.message); }
    }
    function stopCamera(){ if (currentStream){ currentStream.getTracks().forEach(t=>t.stop()); currentStream=null; } }
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia){ startCamera(); }

    // ====== èªéŸ³ï¼šæŒ‘é¸ä¸­æ–‡ï¼ˆå°ç£å„ªå…ˆï¼‰ ======
    function pickZhTWVoice() {
      const vs = speechSynthesis.getVoices();
      return vs.find(v => /zh(-|_)TW/i.test(v.lang))
          || vs.find(v => /zh/i.test(v.lang))
          || vs[0];
    }
    if ('speechSynthesis' in window) {
      speechSynthesis.onvoiceschanged = () => { pickZhTWVoice(); };
    }

    // ====== å…±ç”¨ speakï¼ˆåŒæ­¥æŒ‰éˆ•æ–‡å­—ï¼‰ ======
    function speak(text, btnId) {
      if (!('speechSynthesis' in window)) { alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³æ’­å ±'); return; }
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 1; u.pitch = 1; u.volume = 1;
      const v = pickZhTWVoice(); 
      if (v) u.voice = v;
      speechSynthesis.cancel();

      const resetBtn = () => {
        const b = document.getElementById(btnId);
        if (b) b.textContent = (btnId === 'newsBtn') ? 'ğŸ“° æ’­å ±æ–°è' : 'ğŸ”Š èªéŸ³æ’­å ±';
      };
      u.onend = resetBtn;
      u.oncancel = resetBtn;
      u.onerror = resetBtn;

      const b = document.getElementById(btnId);
      if (b) b.textContent = 'â¸ æš«åœæ’­å ±';
      speechSynthesis.speak(u);
    }

    // ====== å¤©æ°£ APIï¼ˆOpen-Meteoï¼Œå°åŒ—ï¼‰ ======
    async function fetchWeatherTaipei(){
      try{
        const url = 'https://api.open-meteo.com/v1/forecast?latitude=25.033&longitude=121.565&current=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min&timezone=Asia%2FTaipei';
        const r = await fetch(url);
        const j = await r.json();
        const cur = Math.round(j.current.temperature_2m);
        const tmax = Math.round(j.daily.temperature_2m_max[0]);
        const tmin = Math.round(j.daily.temperature_2m_min[0]);
        return { cur, tmax, tmin };
      }catch(e){
        console.warn('weather error', e);
        return null;
      }
    }

    // ====== ä»Šæ—¥æ‘˜è¦æ’­å ±ï¼ˆtoggleï¼Œå«å¤©æ°£ï¼‰ ======
    async function speakToday(){
      const date = document.getElementById('date')?.textContent || '';
      const heart = (document.getElementById('heartRate')?.textContent) || 'å¿ƒè·³ä¸ƒåäºŒ';
      const bp    = (document.getElementById('bloodPressure')?.textContent) || 'è¡€å£“ä¸€äºŒäº”æ¯”ä¸ƒå…«';
      const temp  = (document.getElementById('temperature')?.textContent) || 'é«”æº«ä¸‰åå…­é»å…­åº¦';
      const tasks = [...document.querySelectorAll('#taskList li')].map(li=>li.textContent.replace(/^â€¢\s*/,'')).join('ï¼›');
      let msg = `æ—©å®‰ï¼ä»Šå¤©æ˜¯ ${date}ã€‚`;

      const w = await fetchWeatherTaipei();
      if (w){ msg += `å°åŒ—ä»Šå¤©å¤©æ°£ ${w.tmin} åˆ° ${w.tmax} åº¦ï¼Œç›®å‰ç´„ ${w.cur} åº¦ã€‚`; }

      msg += `${heart}ï¼Œ${bp}ï¼Œ${temp}ã€‚ä»Šæ—¥ä»»å‹™ï¼š${tasks}ã€‚åŠ æ²¹ï¼`;
      speak(msg, 'speakBtn');
    }

    function toggleSpeak(){
      if ('speechSynthesis' in window && (speechSynthesis.speaking || speechSynthesis.pending)) {
        speechSynthesis.cancel();
        const b = document.getElementById('speakBtn');
        if (b) b.textContent = 'ğŸ”Š èªéŸ³æ’­å ±';
        return;
      }
      speakToday();
    }

    // ====== æ–°èåˆ†é¡èˆ‡å–å¾— ======
    const NEWS_QUERIES = {
      market: 'å°è‚¡ OR è‚¡å¸‚ OR å°ç£ é‡å¤§ æ–°è',
      international: 'åœ‹éš›æ–°è OR åœ‹éš› è¦è',
      tech: 'ç§‘æŠ€ OR ç§‘æŠ€æ–°è OR åŠå°é«”',
      sports: 'é«”è‚² OR é«”è‚²æ–°è OR é«”è‚²è³½äº‹',
      taiwan: 'å°ç£ è¦è OR ç„¦é»æ–°è'
    };
    function getSelectedCategory(){
      const sel = document.getElementById('newsCategory');
      return sel?.value || 'market';
    }
    (function restoreCategory(){
      const sel = document.getElementById('newsCategory');
      if (!sel) return;
      const saved = localStorage.getItem('newsCategory') || 'market';
      sel.value = saved;
      sel.addEventListener('change', () => {
        localStorage.setItem('newsCategory', sel.value);
      });
    })();

    async function fetchNewsByCategory(cat, maxItems=3){
      const query = NEWS_QUERIES[cat] || NEWS_QUERIES.market;
      const rss = 'https://news.google.com/rss/search?q=' + encodeURIComponent(query) + '&hl=zh-TW&gl=TW&ceid=TW:zh-Hant';
      const url = 'https://api.allorigins.win/get?url=' + encodeURIComponent(rss);
      try{
        const r = await fetch(url);
        const j = await r.json();
        const xml = j.contents;
        const doc = new DOMParser().parseFromString(xml, 'text/xml');
        const items = Array.from(doc.querySelectorAll('item')).slice(0, maxItems);
        return items.map(it => it.querySelector('title')?.textContent.trim()).filter(Boolean);
      }catch(e){
        console.warn('news error', e);
        return ['æœ€æ–°ç„¦é»æ›´æ–°','æ›´å¤šå³æ™‚æ¶ˆæ¯','è«‹ç¨å¾Œå†è©¦'];
      }
    }

    // ====== æ–°èæ‘˜è¦ï¼ˆä¸å«å¤©æ°£ï¼‰ ======
    async function newsSummary(){
      const titles = await fetchNewsByCategory(getSelectedCategory(), 3);
      if (titles && titles.length){
        const cleaned = titles.map(t => t.replace(/\s*-\s*[^-\u4e00-\u9fa5]+$/,''));
        return 'æœ€æ–°æ–°èï¼š' + cleaned.join('ï¼›') + 'ã€‚';
      }
      return 'ç›®å‰ç„¡æ³•å–å¾—æœ€æ–°æ–°èã€‚';
    }

    async function speakNews(){
      const msg = await newsSummary();
      speak(msg, 'newsBtn');
    }

    function toggleNews(){
      if ('speechSynthesis' in window && (speechSynthesis.speaking || speechSynthesis.pending)) {
        speechSynthesis.cancel();
        const b = document.getElementById('newsBtn');
        if (b) b.textContent = 'ğŸ“° æ’­å ±æ–°è';
        return;
      }
      speakNews();
    }

    // ====== éŸ³æ¨‚ï¼ˆtoggleï¼‰ ======
    function toggleMusic(){
      const audio = document.getElementById('bgMusic');
      const btn = document.getElementById('musicBtn');
      if (!audio) { alert('æ‰¾ä¸åˆ°éŸ³æ¨‚æ’­æ”¾å™¨'); return; }
      if (audio.paused){
        audio.play()
          .then(()=> { if (btn) btn.textContent = 'â¸ éŸ³æ¨‚æš«åœ'; })
          .catch(e => alert('ç„¡æ³•æ’­æ”¾éŸ³æ¨‚ï¼š' + e.message));
      } else {
        audio.pause();
        if (btn) btn.textContent = 'ğŸµ æ’­éŸ³æ¨‚';
      }
    }
    (function bindMusicBtnState(){
      const audio = document.getElementById('bgMusic');
      const btn = document.getElementById('musicBtn');
      if (!audio || !btn) return;
      audio.addEventListener('play',  () => btn.textContent = 'â¸ éŸ³æ¨‚æš«åœ');
      audio.addEventListener('pause', () => btn.textContent = 'ğŸµ æ’­éŸ³æ¨‚');
      audio.addEventListener('ended', () => btn.textContent = 'ğŸµ æ’­éŸ³æ¨‚');
    })();
  </script>
  
</body>
</html>
