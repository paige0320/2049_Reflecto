<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Eterna Mirror · 早安＋新聞播報（語音含天氣）</title>
<style>
  html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; color:#fff;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans","PingFang TC","Microsoft JhengHei",sans-serif; }
  #videoBg { position:fixed; inset:0; width:100%; height:100%; object-fit:cover; transform: scaleX(-1); z-index:0; background:#000; }
  header { position: fixed; top:0; left:0; right:0; z-index:2; text-align:center; padding:1.2vh 2vw 2vh;
    background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,0)); pointer-events:none; }
  h1 { font-size: clamp(26px, 5.5vw, 56px); margin:.2em 0; text-shadow: 0 2px 18px rgba(0,0,0,.45); }
  .sub { opacity:.9; font-size: clamp(12px, 2.5vw, 16px); }
  .time { font-size: clamp(18px, 4vw, 36px); font-variant-numeric: tabular-nums; margin-top:.2em; }
  .side { position: fixed; top: 14vh; bottom: 6vh; width: 22vw; z-index:2;
    display:flex; flex-direction:column; gap: 1.2vh; padding: 0 1vw; pointer-events: none; }
  .left { left: 0; align-items: flex-start; }
  .right { right: 0; align-items: flex-end; }
  .card { width: 100%; max-width: 360px; pointer-events:auto; background: rgba(0,0,0,.45);
    border:1px solid rgba(255,255,255,.18); border-radius: 14px; padding: .8em 1em; backdrop-filter: blur(8px); }
  .title { font-size: clamp(16px,3.6vw,22px); opacity:.95; margin:0 0 .1em; }
  .val { font-size: clamp(16px,3.8vw,24px); font-variant-numeric: tabular-nums; opacity:.95; }
  .note { font-size: clamp(12px,2.6vw,16px); opacity:.8; }
  .tasks li { margin: .2em 0; font-size: clamp(14px,3.6vw,18px); opacity:.95; }
  .gm-card { flex:1; display:flex; }
  #gmWrap { display:flex; align-items:center; justify-content:center; width:100%; border-radius:14px;
    background: rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.18); padding:.4em; }
  #gmWrap img { max-width:100%; max-height:100%; border-radius:12px; object-fit:contain; }
  .floating { position: fixed; right: 2vw; bottom: 8vh; z-index:2; display:flex; gap:.6em; align-items:center; }
  .btn { background: rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.25); border-radius:12px; padding:.55em .85em; backdrop-filter: blur(8px); font-size: clamp(12px,2.8vw,14px); }
  .select { appearance:none; background: rgba(0,0,0,.45); color:#fff; border:1px solid rgba(255,255,255,.25); border-radius:12px; padding:.55em .85em; backdrop-filter: blur(8px); font-size: clamp(12px,2.8vw,14px); }
  @media (max-width: 1024px){ .side { width: 28vw; gap: 1vh; } }
  @media (max-width: 768px){ header { padding: .8vh 2vw 1.2vh; } .side { width: 34vw; top: 12vh; bottom: 8vh; } .title { font-size: clamp(14px,4vw,18px); } .val { font-size: clamp(14px,4.4vw,20px); } }
</style>
</head>
<body>
  <video id="videoBg" autoplay playsinline muted></video>
  <header>
    <h1>早安，今天也一起加油</h1>
    <div class="sub" id="date"></div>
    <div class="time" id="time"></div>
  </header>

  <!-- 左側：服藥提醒 / 親友問候 / 早安圖 -->
  <section class="side left">
    <div class="card">
      <div class="title">服藥提醒</div>
      <div class="val">早上 A 藥 1 顆</div>
      <div class="note">09:00 記得服用</div>
    </div>
    <div class="card">
      <div class="title">親友問候</div>
      <div class="val">孫女：早安阿公 ❤️</div>
    </div>
    <div class="gm-card">
      <div id="gmWrap">
        <img id="gmImg" src="" alt="早安圖">
      </div>
    </div>
  </section>

  <!-- 右側：心跳（置頂） / 血壓（含體溫副標） / 今日任務 -->
  <section class="side right">
    <div class="card">
      <div class="title">心跳</div>
      <div class="val">72 bpm</div>
    </div>
    <div class="card">
      <div class="title">血壓</div>
      <div class="val">125 / 78</div>
      <div class="note">體溫 36.6 °C</div>
    </div>
    <div class="card">
      <div class="title">今日任務</div>
      <ul id="taskList" class="tasks">
        <li>• 去醫院復健（10:00）</li>
        <li>• 圖書館書到期（今天或線上續借）</li>
        <li>• 測一次血壓</li>
      </ul>
    </div>
  </section>

  <div class="floating">
    <button class="btn" id="speakBtn" onclick="toggleSpeak()">🔊 語音播報</button>
    <select id="newsCategory" class="select" title="選擇新聞分類">
      <option value="market">股市</option>
      <option value="international">國際</option>
      <option value="tech">科技</option>
      <option value="sports">體育</option>
      <option value="taiwan">台灣</option>
    </select>
    <button class="btn" id="newsBtn" onclick="toggleNews()">📰 播報新聞</button>
    <button class="btn" id="musicBtn" onclick="toggleMusic()">🎵 播音樂</button>
  </div>

  <!-- 音樂播放器 -->
  <audio id="bgMusic" src="music/sample.mp3" loop></audio>

  <script>
    // ====== 時間 ======
    function pad(n){return n<10? '0'+n : n}
    function tick(){
      const now = new Date();
      document.getElementById('date').textContent =
        now.toLocaleDateString('zh-TW',{year:'numeric',month:'long',day:'numeric',weekday:'long'});
      document.getElementById('time').textContent = pad(now.getHours()) + ':' + pad(now.getMinutes());
    }
    setInterval(tick, 1000); tick();

    // ====== 任務：固定兩項 + 每日再抽 1 項 ======
    const fixedTasks = ['去醫院復健（10:00）','圖書館書到期（今天或線上續借）'];
    const pool = ['喝水 6 杯','伸展 10 分鐘','看看昨天的照片 / 留言','去社區中庭走走 5 分鐘','水果一份（香蕉/蘋果）','打電話給朋友問候 5 分鐘'];
    function pickTasks(){
      const i = Math.floor(Math.random()*pool.length);
      const selected = pool[i];
      document.getElementById('taskList').innerHTML = ['• '+fixedTasks[0],'• '+fixedTasks[1],'• '+selected].map(t=>'<li>'+t+'</li>').join('');
    }
    pickTasks();

    // ====== 早安圖：隨機一張 ======
    const gmImages = [
      "images/goodmorning/1.jpg",
      "images/goodmorning/2.jpg",
      "images/goodmorning/3.jpg",
      "images/goodmorning/4.jpg",
      "images/goodmorning/5.jpg",
      "images/goodmorning/6.jpg",
      "images/goodmorning/7.jpg",
      "images/goodmorning/8.jpg",
      "images/goodmorning/9.jpg"
    ];
    (function showRandomGM(){
      const idx = Math.floor(Math.random()*gmImages.length);
      const el = document.getElementById('gmImg');
      if (el) el.src = gmImages[idx];
    })();

    // ====== 相機（可移除；僅作為背景） ======
    let currentFacing = 'user', currentStream = null;
    async function startCamera(){
      stopCamera();
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: currentFacing, width: { ideal: 1280 }, height: { ideal: 720 } },
          audio: false
        });
        currentStream = stream;
        const video = document.getElementById('videoBg');
        video.srcObject = stream;
      } catch (e) { console.warn('無法開啟相機：' + e.message); }
    }
    function stopCamera(){ if (currentStream){ currentStream.getTracks().forEach(t=>t.stop()); currentStream=null; } }
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia){ startCamera(); }

    // ====== 語音：挑選中文（台灣優先） ======
    function pickZhTWVoice() {
      const vs = speechSynthesis.getVoices();
      return vs.find(v => /zh(-|_)TW/i.test(v.lang))
          || vs.find(v => /zh/i.test(v.lang))
          || vs[0];
    }
    if ('speechSynthesis' in window) {
      speechSynthesis.onvoiceschanged = () => { pickZhTWVoice(); };
    }

    // ====== 共用 speak（同步按鈕文字） ======
    function speak(text, btnId) {
      if (!('speechSynthesis' in window)) { alert('此瀏覽器不支援語音播報'); return; }
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 1; u.pitch = 1; u.volume = 1;
      const v = pickZhTWVoice(); 
      if (v) u.voice = v;
      speechSynthesis.cancel();

      const resetBtn = () => {
        const b = document.getElementById(btnId);
        if (b) b.textContent = (btnId === 'newsBtn') ? '📰 播報新聞' : '🔊 語音播報';
      };
      u.onend = resetBtn;
      u.oncancel = resetBtn;
      u.onerror = resetBtn;

      const b = document.getElementById(btnId);
      if (b) b.textContent = '⏸ 暫停播報';
      speechSynthesis.speak(u);
    }

    // ====== 天氣 API（Open-Meteo，台北） ======
    async function fetchWeatherTaipei(){
      try{
        const url = 'https://api.open-meteo.com/v1/forecast?latitude=25.033&longitude=121.565&current=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min&timezone=Asia%2FTaipei';
        const r = await fetch(url);
        const j = await r.json();
        const cur = Math.round(j.current.temperature_2m);
        const tmax = Math.round(j.daily.temperature_2m_max[0]);
        const tmin = Math.round(j.daily.temperature_2m_min[0]);
        return { cur, tmax, tmin };
      }catch(e){
        console.warn('weather error', e);
        return null;
      }
    }

    // ====== 今日摘要播報（toggle，含天氣） ======
    async function speakToday(){
      const date = document.getElementById('date')?.textContent || '';
      const heart = (document.getElementById('heartRate')?.textContent) || '心跳七十二';
      const bp    = (document.getElementById('bloodPressure')?.textContent) || '血壓一二五比七八';
      const temp  = (document.getElementById('temperature')?.textContent) || '體溫三十六點六度';
      const tasks = [...document.querySelectorAll('#taskList li')].map(li=>li.textContent.replace(/^•\s*/,'')).join('；');
      let msg = `早安！今天是 ${date}。`;

      const w = await fetchWeatherTaipei();
      if (w){ msg += `台北今天天氣 ${w.tmin} 到 ${w.tmax} 度，目前約 ${w.cur} 度。`; }

      msg += `${heart}，${bp}，${temp}。今日任務：${tasks}。加油！`;
      speak(msg, 'speakBtn');
    }

    function toggleSpeak(){
      if ('speechSynthesis' in window && (speechSynthesis.speaking || speechSynthesis.pending)) {
        speechSynthesis.cancel();
        const b = document.getElementById('speakBtn');
        if (b) b.textContent = '🔊 語音播報';
        return;
      }
      speakToday();
    }

    // ====== 新聞分類與取得 ======
    const NEWS_QUERIES = {
      market: '台股 OR 股市 OR 台灣 重大 新聞',
      international: '國際新聞 OR 國際 要聞',
      tech: '科技 OR 科技新聞 OR 半導體',
      sports: '體育 OR 體育新聞 OR 體育賽事',
      taiwan: '台灣 要聞 OR 焦點新聞'
    };
    function getSelectedCategory(){
      const sel = document.getElementById('newsCategory');
      return sel?.value || 'market';
    }
    (function restoreCategory(){
      const sel = document.getElementById('newsCategory');
      if (!sel) return;
      const saved = localStorage.getItem('newsCategory') || 'market';
      sel.value = saved;
      sel.addEventListener('change', () => {
        localStorage.setItem('newsCategory', sel.value);
      });
    })();

    async function fetchNewsByCategory(cat, maxItems=3){
      const query = NEWS_QUERIES[cat] || NEWS_QUERIES.market;
      const rss = 'https://news.google.com/rss/search?q=' + encodeURIComponent(query) + '&hl=zh-TW&gl=TW&ceid=TW:zh-Hant';
      const url = 'https://api.allorigins.win/get?url=' + encodeURIComponent(rss);
      try{
        const r = await fetch(url);
        const j = await r.json();
        const xml = j.contents;
        const doc = new DOMParser().parseFromString(xml, 'text/xml');
        const items = Array.from(doc.querySelectorAll('item')).slice(0, maxItems);
        return items.map(it => it.querySelector('title')?.textContent.trim()).filter(Boolean);
      }catch(e){
        console.warn('news error', e);
        return ['最新焦點更新','更多即時消息','請稍後再試'];
      }
    }

    // ====== 新聞摘要（不含天氣） ======
    async function newsSummary(){
      const titles = await fetchNewsByCategory(getSelectedCategory(), 3);
      if (titles && titles.length){
        const cleaned = titles.map(t => t.replace(/\s*-\s*[^-\u4e00-\u9fa5]+$/,''));
        return '最新新聞：' + cleaned.join('；') + '。';
      }
      return '目前無法取得最新新聞。';
    }

    async function speakNews(){
      const msg = await newsSummary();
      speak(msg, 'newsBtn');
    }

    function toggleNews(){
      if ('speechSynthesis' in window && (speechSynthesis.speaking || speechSynthesis.pending)) {
        speechSynthesis.cancel();
        const b = document.getElementById('newsBtn');
        if (b) b.textContent = '📰 播報新聞';
        return;
      }
      speakNews();
    }

    // ====== 音樂（toggle） ======
    function toggleMusic(){
      const audio = document.getElementById('bgMusic');
      const btn = document.getElementById('musicBtn');
      if (!audio) { alert('找不到音樂播放器'); return; }
      if (audio.paused){
        audio.play()
          .then(()=> { if (btn) btn.textContent = '⏸ 音樂暫停'; })
          .catch(e => alert('無法播放音樂：' + e.message));
      } else {
        audio.pause();
        if (btn) btn.textContent = '🎵 播音樂';
      }
    }
    (function bindMusicBtnState(){
      const audio = document.getElementById('bgMusic');
      const btn = document.getElementById('musicBtn');
      if (!audio || !btn) return;
      audio.addEventListener('play',  () => btn.textContent = '⏸ 音樂暫停');
      audio.addEventListener('pause', () => btn.textContent = '🎵 播音樂');
      audio.addEventListener('ended', () => btn.textContent = '🎵 播音樂');
    })();
  </script>
  
</body>
</html>
